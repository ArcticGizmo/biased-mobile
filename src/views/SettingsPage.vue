<template>
  <BasePage title="Settings">
    <div class="content m-4">
      <IonButton @click="onCreateBackup()">Create Backup</IonButton>
      <IonButton @click="onLoadBackup()">Load Backup</IonButton>
      <IonButton @click="clearCards()">Clear All Cards</IonButton>
      <IonButton router-link="/test">test</IonButton>
      <!-- <IonButton :href="a.webviewPath" download="my-file.json" >Download</IonButton> -->
    </div>
  </BasePage>
</template>

<script setup lang="ts">
import { IonButton } from '@ionic/vue';
import BasePage from './BasePage.vue';
import { useKPopCards } from '@/composables/kPopCards';
import { showLoading } from '@/composables/modals';
import { createBackup, loadBackup } from '@/composables/backup';
import { useToast } from '@/composables/toast';
import { alertOutline, happyOutline, sadOutline } from 'ionicons/icons';

const { cards, importBackup, clearCards } = useKPopCards();
const { showToast } = useToast();

const onCreateBackup = async () => {
  const loading = await showLoading();

  try {
    const resp = await createBackup([...cards.value]);
    if (resp.ok) {
      console.log('backup created at', resp.path);
      await showToast({ message: 'Backup created!', color: 'success' });
    }
  } catch (error) {
    console.error(error);
  } finally {
    loading.dismiss();
  }
};

const onLoadBackup = async () => {
  const loading = await showLoading();

  try {
    const resp = await loadBackup();

    if (!resp.ok) {
      console.error('could not load backup', resp.error);
      await showToast({ color: 'danger', message: 'Could not import backup', icon: sadOutline });
      return;
    }

    await importBackup(resp.backup);
    await showToast({ color: 'success', message: 'Backup imported successfully!', icon: happyOutline });
  } catch (error) {
    console.error(error);
    await showToast({ color: 'danger', message: 'Something went wrong :(', icon: alertOutline });
  } finally {
    loading.dismiss();
  }
};
</script>
